# .github/workflows/release.yml

name: Release Go Binary

on:
  push:
    tags:
      - 'v*' # Trigger workflow when new tag like v0.2.0 is pushed

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Permission to create releases and upload assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod' # Use Go version from go.mod

      - name: Get version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Build binaries
        env:
          CGO_ENABLED: 0
        run: |
          VERSION="${{ env.VERSION }}"
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          GIT_COMMIT="${GITHUB_SHA::7}"
          LDFLAGS="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}"
          
          echo "Building binaries for version ${VERSION}..."
          echo "Build Time: ${BUILD_TIME}"
          echo "Git Commit: ${GIT_COMMIT}"
          
          # Linux
          echo "Building for Linux..."
          GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o "panggil_${VERSION}_linux_amd64" .
          GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o "panggil_${VERSION}_linux_arm64" .
          
          # macOS (Darwin)
          echo "Building for macOS..."
          GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o "panggil_${VERSION}_darwin_amd64" .
          GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o "panggil_${VERSION}_darwin_arm64" .
          
          # Windows
          echo "Building for Windows..."
          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o "panggil_${VERSION}_windows_amd64.exe" .
          
          echo "Build complete!"
          ls -la panggil_*

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: "panggil_*"
